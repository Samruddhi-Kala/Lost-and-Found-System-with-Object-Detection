{% extends "base.html" %}

{% block content %}
<div class="page-header">
  <div class="page-header-content">
    <div class="page-icon">‚ú®</div>
    <h1 class="page-title">Potential Matches</h1>
    <p class="page-description">AI-powered matches between lost and found items</p>
  </div>
</div>

<div class="matches-container">
  {% if suggestions %}
    <div class="matches-section">
      <div class="section-header-small">
        {% if found_id %}
          <h2>üí° Suggestions for Found Item #{{ found_id }}</h2>
        {% elif lost_id %}
          <h2>üí° Suggestions for Lost Item #{{ lost_id }}</h2>
        {% else %}
          <h2>üí° Suggested Matches</h2>
        {% endif %}
      </div>

      <div class="matches-grid">
        {% for match in suggestions %}
        <div class="match-card-modern">
          <div class="match-image">
            {% set imgpath = (match.image or '')|replace('\\','/') %}
            {% if imgpath %}
              <img src="{{ url_for('uploaded_file', filename=imgpath.split('/')[-1]) }}" alt="Item image" />
            {% else %}
              <div class="no-image">üì∑</div>
            {% endif %}
            <div class="match-score-badge">
              {{ "%.0f"|format((1 - match.score) * 100) }}% Match
            </div>
          </div>
          <div class="match-content">
            <h3 class="match-title">
              Item #{{ match.lost_id if match.lost_id is defined else (match.found_id if match.found_id is defined else 'N/A') }}
            </h3>
            <p class="match-description">{{ match.desc }}</p>
            <div class="match-meta-info">
              <span class="meta-badge">üéØ Score: {{ "%.2f"|format(match.score) }}</span>
            </div>
            <div class="match-actions">
              <button class="button button-primary" data-report="{{ match.lost_id if match.lost_id is defined else (match.found_id if match.found_id is defined else '') }}" onclick="confirmReport(this)">
                ‚úì Confirm Match
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if pairs %}
    <div class="matches-section">
      <div class="section-header-small">
        <h2>üîÑ All Potential Matches</h2>
      </div>

      <div class="pairs-grid">
        {% for pair in pairs %}
        <div class="pair-card">
          <div class="pair-item found-side">
            <span class="pair-label">Found</span>
            <div class="pair-image">
              <img src="{{ url_for('uploaded_file', filename=pair.found_img.split('/')[-1]) }}" alt="Found item">
            </div>
            <h4>Item #{{ pair.found }}</h4>
            <button class="button button-secondary" data-report="{{ pair.found }}" onclick="confirmReport(this)">
              ‚úì Confirm
            </button>
          </div>
          
          <div class="pair-connector">
            <div class="connector-line"></div>
            <div class="connector-badge">
              {{ "%.0f"|format((1 - pair.score) * 100) }}%
            </div>
          </div>
          
          <div class="pair-item lost-side">
            <span class="pair-label">Lost</span>
            <div class="pair-image">
              <img src="{{ url_for('uploaded_file', filename=pair.lost_img.split('/')[-1]) }}" alt="Lost item">
            </div>
            <h4>Item #{{ pair.lost }}</h4>
            <button class="button button-secondary" data-report="{{ pair.lost }}" onclick="confirmReport(this)">
              ‚úì Confirm
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if not suggestions and not pairs %}
    <div class="empty-state">
      <div class="empty-icon">üîç</div>
      <h3>No Matches Found Yet</h3>
      <p>Check back later as more items are reported</p>
      <a href="{{ url_for('index') }}" class="button button-primary">Go Back Home</a>
    </div>
  {% endif %}
</div>

<script>
async function confirmReport(btn){
  const reportId = btn.getAttribute('data-report');
  if(!reportId){ alert('No report id'); return; }
  btn.disabled = true;
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Confirming...';
  try{
    const res = await fetch('/admin/confirm', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({report_id: parseInt(reportId), val: 1})
    });
    const j = await res.json();
    if(j.ok){ 
      btn.innerHTML = '‚úì Confirmed';
      btn.classList.add('confirmed');
    } else { 
      btn.innerHTML = '‚úó Failed'; 
      btn.disabled = false; 
    }
  }catch(err){ 
    console.error(err); 
    btn.innerHTML = originalText; 
    btn.disabled = false; 
  }
}
</script>
{% endblock %}
